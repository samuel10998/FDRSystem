services:
  mysql:
    image: mysql:8.4
    restart: unless-stopped
    environment:
      MYSQL_DATABASE: database
      MYSQL_USER: user
      MYSQL_PASSWORD_FILE: /run/secrets/db_password
      MYSQL_ROOT_PASSWORD_FILE: /run/secrets/db_root_password
    ports:
      - "3306:3306"
    volumes:
      - db-data:/var/lib/mysql
    secrets:
      - db_password
      - db_root_password
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h localhost -u root -p\"$$(cat /run/secrets/db_root_password)\" || exit 1"]
      interval: 10s
      retries: 5
    networks:
      - spring-network

  phpmyadmin:
    image: phpmyadmin:5.2.1-apache
    depends_on:
      mysql:
        condition: service_healthy
    restart: unless-stopped
    environment:
      PMA_HOST: mysql
    ports:
      - "8081:80"
    networks:
      - spring-network

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    depends_on:
      mysql:
        condition: service_healthy
    restart: unless-stopped
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/database?allowPublicKeyRetrieval=true&useSSL=false&serverTimezone=UTC
      SPRING_DATASOURCE_USERNAME: user
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      SPRING_JPA_SHOW_SQL: "true"
    ports:
      - "8080:8080"
    volumes:
      - ./uploads/avatars:/app/uploads/avatars
    secrets:
      - jwt_secret
      - db_password
      - admin_email
      - admin_password
      - admin_seed_force_reset
    networks:
      - spring-network
    healthcheck:
      test: [ "CMD-SHELL", "wget -qO- http://localhost:8080/actuator/health | grep -q '\"status\":\"UP\"'" ]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 25s

  # ------------------------ FRONTEND (DEV) -------------------------
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      target: dev                 # ✅ dôležité: aby sa nespustil nginx stage
    restart: unless-stopped
    ports:
      - "3000:3000"
    volumes:
      - ./frontend:/app
      - /app/node_modules
    environment:
      CHOKIDAR_USEPOLLING: "true" # ✅ stabilnejší watch na Windows/WSL
      WATCHPACK_POLLING: "true"
    networks:
      - spring-network
    depends_on:
      - backend

  # ------------------------ FRONTEND (PROD skeleton) -------------------------
  # Toto je iba "pripravené na produkciu" – momentálne to NEPOUŽÍVAM.
  # Je to tu preto, aby posledný krok v budúcnosti bol už len:
  #  - kúpiť doménu/server
  #  - nastaviť reverse proxy + HTTPS
  #  - spustiť compose s prod profilom
  #
  # Spustenie (len keď budem chcieť simulovať produkciu):
  #   docker compose --profile prod up -d --build frontend_prod
  #
  # Poznámka: Tento kontajner builduje statické súbory (npm run build)
  # a servuje ich cez nginx na porte 80 (mapované na host 3001).
  frontend_prod:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      target: prod
    profiles: [ "prod" ]
    restart: unless-stopped
    ports:
      - "3001:80"
    networks:
      - spring-network
    depends_on:
      - backend

  smtp4dev:
    image: rnwood/smtp4dev:latest
    restart: unless-stopped
    ports:
      - "4000:80"
      - "2525:25"
    volumes:
      - smtp4dev-data:/smtp4dev
    networks:
      - spring-network

volumes:
  db-data:
  smtp4dev-data:

secrets:
  jwt_secret:
    file: ./secrets/jwt_secret.txt
  db_password:
    file: ./secrets/db_password.txt
  db_root_password:
    file: ./secrets/db_root_password.txt
  admin_email:
    file: ./secrets/admin_email.txt
  admin_password:
    file: ./secrets/admin_password.txt
  admin_seed_force_reset:
    file: ./secrets/admin_seed_force_reset.txt

networks:
  spring-network:
